# Default Virtual Host Configuration for PHP Apache Application
# This configuration sets up the main virtual host on port 8088

<VirtualHost *:8088>
    # Server configuration
    ServerAdmin farajassulai@gmail.com
    ServerName php-apache-host
    ServerAlias www.php-apache-host
    
    # Document root - where the PHP files are located
    DocumentRoot /var/www/html
    
    # Directory permissions and options
    <Directory /var/www/html>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
        
        # PHP Configuration
        DirectoryIndex index.php index.html
        
        # Security headers
        Header always set X-Content-Type-Options nosniff
        Header always set X-Frame-Options DENY
        Header always set X-XSS-Protection "1; mode=block"
        Header always set Referrer-Policy "strict-origin-when-cross-origin"
        Header always set Content-Security-Policy "default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self'"
    </Directory>
    
    # Error and Access Logs
    ErrorLog /var/log/apache2/error.log
    CustomLog /var/log/apache2/access.log combined
    LogLevel warn
    
    # PHP Error Handling
    php_flag log_errors on
    php_value error_log /var/log/apache2/php_errors.log
    
    # Performance Settings
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/plain
        AddOutputFilterByType DEFLATE text/html
        AddOutputFilterByType DEFLATE text/xml
        AddOutputFilterByType DEFLATE text/css
        AddOutputFilterByType DEFLATE application/xml
        AddOutputFilterByType DEFLATE application/xhtml+xml
        AddOutputFilterByType DEFLATE application/rss+xml
        AddOutputFilterByType DEFLATE application/javascript
        AddOutputFilterByType DEFLATE application/x-javascript
        AddOutputFilterByType DEFLATE application/json
    </IfModule>
    
    # Cache Control for static files
    <IfModule mod_expires.c>
        ExpiresActive On
        ExpiresByType image/jpg "access plus 1 month"
        ExpiresByType image/jpeg "access plus 1 month"
        ExpiresByType image/gif "access plus 1 month"
        ExpiresByType image/png "access plus 1 month"
        ExpiresByType image/webp "access plus 1 month"
        ExpiresByType text/css "access plus 1 month"
        ExpiresByType application/pdf "access plus 1 month"
        ExpiresByType text/javascript "access plus 1 month"
        ExpiresByType application/javascript "access plus 1 month"
        ExpiresByType application/x-shockwave-flash "access plus 1 month"
        ExpiresByType image/x-icon "access plus 1 year"
        ExpiresByType font/woff "access plus 1 year"
        ExpiresByType font/woff2 "access plus 1 year"
        ExpiresDefault "access plus 2 days"
    </IfModule>
    
    # Rewrite rules for clean URLs (if needed)
    <IfModule mod_rewrite.c>
        RewriteEngine On
        
        # Remove .php extension from URLs (optional)
        # RewriteCond %{REQUEST_FILENAME} !-d
        # RewriteCond %{REQUEST_FILENAME} !-f
        # RewriteRule ^([^\.]+)$ $1.php [NC,L]
        
        # Security: Block access to sensitive files
        RewriteRule ^(.*/)?\.git/ - [F,L]
        RewriteRule ^(.*/)?\.env$ - [F,L]
        RewriteRule ^(.*/)?composer\.(json|lock)$ - [F,L]
        RewriteRule ^(.*/)?package\.json$ - [F,L]
        RewriteRule ^(.*/)?\.htaccess$ - [F,L]
    </IfModule>
    
    # Security: Block access to PHP configuration files
    <Files "*.ini">
        Require all denied
    </Files>
    
    # Security: Block access to backup files
    <FilesMatch "~$">
        Require all denied
    </FilesMatch>
    
    # Security: Disable server-info and server-status for production
    <Location "/server-info">
        Require local
    </Location>
    
    <Location "/server-status">
        Require local
    </Location>
    
    # Environment variables for PHP (these will be available in PHP via getenv())
    SetEnv MYSQL_HOST mysql-db
    SetEnv MYSQL_DATABASE myappdb
    SetEnv MYSQL_USER appuser
    SetEnv MYSQL_PASSWORD MyAppUserPass456!@#
    SetEnv PHP_ENV production
    
</VirtualHost>

# Optional: Redirect HTTP to HTTPS (uncomment if using SSL)
# <VirtualHost *:80>
#     ServerName php-apache-host
#     Redirect permanent / https://php-apache-host/
# </VirtualHost>

version: "3.8"

services:
  mysql-db:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SQLVER: 8.0
        USER_ID: 1010
        USER_NAME: sqluser
        GROUP_ID: 1010
        GROUP_NAME: sqlgroup
        APP_PORT: 3306
        APP_ENV: production
        BASH_SHELL: /bin/bash
        APP_DIR: /var/lib/mysql
        MOUNT1: /var/lib/mysql
        MOUNT2: /var/log/mysql
        MYSQL_ROOT_PASSWORD: rootpass
        MYSQL_DATABASE: mydb
        MYSQL_PASSWORD: MyAppUserPass456
        MYSQL_USER: sqluser
    container_name: mysql-project
    hostname: mysql-host
    labels:
      - "maintainer=farajassulai"
      - "app=mysql-database"
      - "service=database"
    environment:
      MYSQL_ROOT_PASSWORD: rootpass
      MYSQL_DATABASE: mydb
      MYSQL_USER: sqluser
      MYSQL_PASSWORD: MyAppUserPass456
      SQLVER: 8.0
      USER_ID: "1010"
      USER_NAME: sqluser
      GROUP_ID: "1010"
      GROUP_NAME: sqlgroup
      APP_PORT: "3306"
      APP_ENV: production
      BASH_SHELL: /bin/bash
      APP_DIR: /var/lib/mysql
      MOUNT1: /var/lib/mysql
      MOUNT2: /var/log/mysql
      TZ: Europe/Paris
    networks:
      - mysql-network
    dns:
      - 1.1.1.1
      - 8.8.8.8
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - mysql_logs:/var/log/mysql
    deploy:
      resources:
        limits:
          memory: 1g
          cpus: '0.5'
        reservations:
          memory: 512m
          cpus: '0.25'
    ulimits:
      nofile:
        soft: 1024
        hard: 65536
      nproc:
        soft: 1024
        hard: 4096
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -u root --password=\"$MYSQL_ROOT_PASSWORD\" || exit 1"]
      interval: 30s
      timeout: 15s
      retries: 3
      start_period: 30s
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "10"
        compress: "true"
    security_opt:
      - "no-new-privileges:true"
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
      - DAC_OVERRIDE
      - FOWNER
      - FSETID
      - SYS_RESOURCE
    user: "1010:1010"
    restart: unless-stopped
    working_dir: /var/lib/mysql

volumes:
  mysql_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./mysql_data
  mysql_logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./mysql_logs

networks:
  mysql-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.18.19.0/24
